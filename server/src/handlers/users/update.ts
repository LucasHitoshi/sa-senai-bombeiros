import { FastifyInstance } from 'fastify'
import { prisma } from '../../lib/prisma'
import { updateSchema } from '../../schemas/userSchemas'

export async function updateHandler(
  req: FastifyRequest,
  res: FastifyResponse,
  app: FastifyInstance,
) {
  const { id } = req.params as { id: string } // Buscar o id do usu치rio

  // Faz uma requisi칞칚o do body para pegar o email senha e nome
  const { email, password, name, gender, isActive } = updateSchema.parse(
    req.body,
  )

  // Valida칞칚o dos dados recebidos
  if (!email && !password && !name && !gender && !isActive) {
    return res
      .status(400)
      .send({ message: '游댮 Nenhuma informa칞칚o foi fornecida' })
  }

  // Buscar usu치rio pelo ID se n칚o existir retorna um erro
  const existingUser = await prisma.user.findUnique({
    where: {
      id: parseInt(id),
    },
  })

  if (!existingUser) {
    return res.status(404).send({
      message: `游댮 N칚o foi poss칤vel realizar a pesquisa pelo ${id}. Usu치rio n칚o encontrado.`,
    })
  }

  // Informa칞칫es para serem atualizadas
  const updatedUserData: {
    email?: string
    password?: string
    name?: string
    gender?: string
    isActive?: boolean
  } = {}

  // Se tiver um email, atualizar o email
  if (email) {
    updatedUserData.email = email
  }

  // Se tiver uma senha, atualizar a senha
  if (password) {
    // Criptografar a nova senha antes de atualizar
    const hashedPassword = await app.bcrypt.hash(password)
    updatedUserData.password = hashedPassword
  }

  // Se tiver um nome, atualizar o nome
  if (name) {
    updatedUserData.name = name
  }

  // Se tiver um genero, atualizar o genero
  if (gender) {
    updatedUserData.gender = gender
  }

  // Se tiver um isActive, atualizar o isActive
  if (isActive) {
    updatedUserData.isActive = isActive
  }

  // Atualizar o usu치rio buscando pelo ID
  const updatedUser = await prisma.user.update({
    where: {
      id: parseInt(id),
    },
    data: updatedUserData,
  })

  return res.send({ msg: '游릭 Usu치rio atualizado com sucesso.', updatedUser })
}
